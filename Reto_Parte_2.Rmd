---
title: "Reto: Modelo SIR y Vacunación Parte 2"
author: "Aldo Resendiz, Aldo Radamés Corral Verdugo, Virginia Díaz Moreno."
date: "Noviembre de 2025"
output: 
  html_document:
    toc: true
    self_contained: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r}
#install.packages("plotly") # Si no la tienes
library(plotly)
```


## El modelo SIR

Consideremos un modelo para describir la dinámica de un grupo de individuos de una población con exposición a una enfermedad que puede contagiarse entre los miembros de la población. Esto puede modelarse como un sistema dinámico denominado $SIR$ para una población de $N$ individuos en la que se considera la interacción entre un conjunto de $S$ individuos *suceptibles* de contraer la enfermedad, un conjunto $I$ de individuos *infectados* y uno conjunto $R$ de individuos *recuperados* de la enfermedad.

Este modelo tiene los siguientes supuestos:

* la probabilidades de infectarse son iguales para todos los individuos de la población;

* la población es homogénea, es decir que los riesgos de infectarse son iguales para toos los suceptibles y que los tiempos para recuperarse son iguales para todos los infectados; y

* el tamaño $N$ de la población es constante.

El modelo maneja los diferentes conjuntos $S$, $I$ y $R$ como si fueran compartimentos bien separados y considera que los individuos pueden pasr de uno a otro en el caso de que se enfermen (cambio $S\rightarrow I$) o que una vez enfermos se recuperen (cambio $I\rightarrow R$). Ademas, se asume que un individuo no puede pasar del conjunto de suceptibles directamente al conjunto de recuperados.

Con estos supuestos y consideraciones, las ecuaciones diferenciales del modelo SIR son:
\[
\begin{aligned}
\frac{dS}{dt}&= -\beta \frac{I}{N} S\\
\frac{dI}{dt}&= \beta\frac{I}{N}S-\gamma I\\\
\frac{dR}{dt}&= \gamma I
\end{aligned}
\]
donde:

* N=S+R+I

* la cantidad $\beta\frac{I}{N}$ representa la razón con que las personas salen del compartimento S (se infectan);

* en la primera ecuación $dS$ representa el cambio debido a las personas que salen del compartimento $S$ (el signo negativo se debe a que las personas salen)

* en la segunda ecuación $dI$ representa el cambio debido a las personas que salen del compartimento $I$ (una parte se debe a las personas que del compartimento $S$ pasan al compartimento $I$, y otra parte se debe a las personas que salen del compartimento $I$ porque se recuperan);

* la cantidad $\gamma$ representa la razón con que las personas se recuperan.

```{r}
# PACKAGES:
library(deSolve)
library(reshape2)
library(ggplot2)

initial_state_values <- c(S = 999999, I = 1, R = 0)
parameters <- c(beta = 1, gamma = 0.1)
times <- seq(from = 0, to = 60, by = 1)   

sir_model <- function(time, state, parameters) {  
    with(as.list(c(state, parameters)), {
        N <- S+I+R 
        lambda <- beta * I/N
        dS <- -lambda * S                
        dI <- lambda * S - gamma * I   
        dR <- gamma * I                  
        return(list(c(dS, dI, dR))) 
    })
}

output <- as.data.frame(ode(y = initial_state_values, 
                            times = times, 
                            func = sir_model,
                            parms = parameters))
```


##  Gráficos de la evolución del sistema

```{r }

# Gráfico del modelo base
output_long <- melt(as.data.frame(output), id = "time")                  

ggplot(data = output_long, aes(x = time, y = value, colour = variable)) +  
  geom_line(linewidth = 1) +                                           
  xlab("Tiempo (días)")+                                         
  ylab("Número de individuos") +                                       
  labs(title = "Modelo SIR Básico", colour = "Subconjunto") +
  theme_minimal() +
  theme(legend.position = "bottom")

```


Con el modelo SIR se define la constante 
\[R_0=\frac{\beta}{\gamma}\]
que representa el número de personas que cada contagiado infecta. Para que la enfermedad analizada logre dispararse en forma de una epidemia debe cumplirse que $R_0 > 1$. 

También se define 
\[R_{eff}=R_0\frac{S}{N}\]
que corresponde al número promedio de personas que cada contagiado infecta. Este segundo valor $R_{eff}$ toma en cuenta de que durante la evolución de la pandemia, al aumentar del número de personas inmunes en la población cada persona contagiada infectará a un número de personas cada vez menor.



## Pregunta 1

Haga cambios en el modelo para tomar en cuenta el hecho de que la población no es constante:

* agregar un término de incremento en $dS$ para tomar en cuenta los individuos nacidos $+bN$

* agregar un término de decremento en $dS$ para tomar en cuenta las personas susceptibles que mueren -$\mu S$

* agregar un término de decremento en $dI$ para tomar en cuenta las personas infectadas que mueren -$\mu I$

* agregar un término de decremento en $dR$ para tomar en cuenta las personas recuperadas que fallecen $-\mu R$

Usar ahora los parámetros
\[
\begin{aligned}
\beta  &=  0.4 days^{-1} &= (0.4 \times 365) years^{-1}\\
\gamma &=  0.2 days^{-1} &= (0.2 \times 365) years^{-1}\\
\mu    &=  \frac{1}{70}years^{-1}\\
b     &=  \frac{1}{70}years^{-1}\\
\end{aligned}
\]
y considerar una duración de 1 año.

```{r }
# Conversión de unidades a días
mu_val <- (1/70)/365
b_val  <- (1/70)/365

parameters_p1 <- c(beta = 0.4, gamma = 0.2, mu = mu_val, b = b_val)
times_p1 <- seq(0, 365, by = 1) # 1 año

# Función SIR con dinámica vital
sir_vital_dynamics <- function(time, state, parameters) {
  with(as.list(c(state, parameters)), {
    N <- S + I + R
    lambda <- beta * I / N
    
    # Ecuaciones modificadas
    dS <- b * N - lambda * S - mu * S
    dI <- lambda * S - gamma * I - mu * I
    dR <- gamma * I - mu * R
    
    return(list(c(dS, dI, dR)))
  })
}

output_p1 <- as.data.frame(ode(y = initial_state_values, times = times_p1, func = sir_vital_dynamics, parms = parameters_p1))

# Gráfico
ggplot(melt(output_p1, id="time"), aes(x=time, y=value, col=variable)) +
  geom_line(linewidth=1) +
  theme_minimal() +
  labs(title = "Modelo con Dinámica Vital (1 año)", y="Población")
```

### Análisis de Resultados: Modelo con Dinámica Vital

La inclusión de nacimientos ($b$) y muertes ($\mu$) transforma el comportamiento del sistema:

* *Susceptibles ($S$):* Tras la caída inicial por el brote, la curva no continúa descendiendo indefinidamente, sino que se estabiliza. Esto ocurre porque los nacimientos ($+bN$) reponen constantemente la población susceptible.
* *Infectados ($I$):* Se observa el pico epidémico clásico, pero la curva no cae a cero absoluto. Se mantiene en un nivel bajo y estable, permitiendo que el virus persista en la población (endemia) al tener siempre nuevos huéspedes disponibles.
* *Recuperados ($R$):* Aumentan rápidamente tras el pico de infección y luego se estabilizan, ya que la mortalidad ($-\mu R$) equilibra la entrada de nuevos recuperados.

*Conclusión:*
El modelo pasa de ser un sistema cerrado (donde la epidemia termina por agotamiento de susceptibles) a un *sistema abierto. Esto permite alcanzar un **equilibrio endémico*, donde la enfermedad coexiste indefinidamente con la población, siendo una representación más realista para enfermedades de larga duración

## Pregunta 2

Considerando el modelo SIR básico, haga cambios para tomar en cuenta un programa de vacunación. Suponga que una fracción $v$ de susceptibles se vacuna de manera que queda inmune (y entra ahora directamente en el conjunto de los recuperados). Calcule la dinámica de la epidemia en este caso usando los parámetros $\beta=0.4$, $\gamma=0.1$ y considere un periodo de 2 años.

Su modelo debe ser capaz de mostrar que si la fracción $v$ es suficiente, no es necesario vacunar a todos los suceptibles para evitar la epidemia. A este efecto se le conoce como *inmunidad de rebaño* y se refiere a que si un sector grande de la población es inmune, entonces los contagios se mantienen a un nivel en el que la enfermedad es eliminada.

¿Cómo se puede calcular la fracción mínima $v$ de personas que se deben vacunar para poder evitar una epidemia? La inmunidad de rebaño ocurre cuando $R_{eff}< 1$.

*Enfoque del Modelo:*
Para modelar un programa de vacunación preventivo asumimos que una fracción $v$ de la población es inmune desde el día 0, por lo que los trasladamos directamente del compartimento de Susceptibles ($S$) al de Recuperados ($R$).

*Condiciones Iniciales:*
* $S_0 = (1 - v)N$
* $I_0 \approx 0$ (pequeña cantidad inicial)
* $R_0 = vN$ (vacunados)

*Cálculo Analítico de la Fracción Mínima ($v$):*
La inmunidad de rebaño se logra cuando el número reproductivo efectivo es menor a 1 ($R_{eff} < 1$), lo que impide que el brote crezca exponencialmente.

$$R_{eff} = R_0 \times \frac{S}{N} < 1$$

Sustituyendo $S = (1-v)N$ y sabiendo que $R_0 = \beta / \gamma$:

$$\frac{\beta}{\gamma} (1-v) < 1$$

Despejando para $v$, obtenemos la fórmula del umbral crítico de vacunación:

$$v > 1 - \frac{1}{R_0}$$

*Aplicación a los datos del problema:*
* $\beta = 0.4$, $\gamma = 0.1 \implies R_0 = 4$.
* Umbral: $v > 1 - 1/4 = 0.75$.

> *Conclusión:* Se debe vacunar a más del *75%* de la población para evitar la epidemia. En la siguiente simulación utilizamos $v=0.8$ (80%), por lo que esperamos ver que la infección se suprima inmediatamente.

```{r }
# 1. Definición de Parámetros
beta_val <- 0.4
gamma_val <- 0.1
N_total <- 1000000
v <- 0.50
# 2. Condiciones Iniciales Modificadas
init_vaccine <- c(S = (1 - v) * N_total - 1, 
                  I = 1, 
                  R = v * N_total)
params_vaccine <- c(beta = beta_val, gamma = gamma_val)
times_vaccine <- seq(0, 365*2, by = 1) # 2 años
# 3. Simulación
output_vaccine <- as.data.frame(ode(y = init_vaccine, 
                                    times = times_vaccine, 
                                    func = sir_model, 
                                    parms = params_vaccine))
# 4. Visualización
ggplot(melt(output_vaccine, id="time"), aes(x=time, y=value, col=variable)) +
  geom_line(linewidth=1) +
  theme_minimal() +
  labs(title = paste0("Dinámica con Vacunación del ", v*100, "%"),
       y = "Población",
       x = "Tiempo (días)")
```
```{r}
# 1. Definición de Parámetros
beta_val <- 0.4
gamma_val <- 0.1
N_total <- 1000000
v <- 0.60
# 2. Condiciones Iniciales Modificadas
init_vaccine <- c(S = (1 - v) * N_total - 1, 
                  I = 1, 
                  R = v * N_total)
params_vaccine <- c(beta = beta_val, gamma = gamma_val)
times_vaccine <- seq(0, 365*2, by = 1) # 2 años
# 3. Simulación
output_vaccine <- as.data.frame(ode(y = init_vaccine, 
                                    times = times_vaccine, 
                                    func = sir_model, 
                                    parms = params_vaccine))
# 4. Visualización
ggplot(melt(output_vaccine, id="time"), aes(x=time, y=value, col=variable)) +
  geom_line(linewidth=1) +
  theme_minimal() +
  labs(title = paste0("Dinámica con Vacunación del ", v*100, "%"),
       y = "Población",
       x = "Tiempo (días)")
```
```{r}
# 1. Definición de Parámetros
beta_val <- 0.4
gamma_val <- 0.1
N_total <- 1000000
v <- 0.70

# 2. Condiciones Iniciales Modificadas
init_vaccine <- c(S = (1 - v) * N_total - 1, 
                  I = 1, 
                  R = v * N_total)

params_vaccine <- c(beta = beta_val, gamma = gamma_val)
times_vaccine <- seq(0, 365*2, by = 1) # 2 años
# 3. Simulación
output_vaccine <- as.data.frame(ode(y = init_vaccine, 
                                    times = times_vaccine, 
                                    func = sir_model, 
                                    parms = params_vaccine))
# 4. Visualización
ggplot(melt(output_vaccine, id="time"), aes(x=time, y=value, col=variable)) +
  geom_line(linewidth=1) +
  theme_minimal() +
  labs(title = paste0("Dinámica con Vacunación del ", v*100, "%"),
       y = "Población",
       x = "Tiempo (días)")
```
```{r}
# 1. Definición de Parámetros
beta_val <- 0.4
gamma_val <- 0.1
N_total <- 1000000
v <- 0.75 

# 2. Condiciones Iniciales Modificadas
# Removemos el 80% de S y lo ponemos en R
init_vaccine <- c(S = (1 - v) * N_total - 1, 
                  I = 1, 
                  R = v * N_total)
params_vaccine <- c(beta = beta_val, gamma = gamma_val)
times_vaccine <- seq(0, 365*2, by = 1) # 2 años
# 3. Simulación
output_vaccine <- as.data.frame(ode(y = init_vaccine, 
                                    times = times_vaccine, 
                                    func = sir_model, 
                                    parms = params_vaccine))
# 4. Visualización

ggplot(melt(output_vaccine, id="time"), aes(x=time, y=value, col=variable)) +
  geom_line(linewidth=1) +
  theme_minimal() +
  labs(title = paste0("Dinámica con Vacunación del ", v*100, "%"),
       y = "Población",
       x = "Tiempo (días)")
```


## Pregunta 3

Haga cambios en el modelo para tomar en cuenta de que la población no es constante:

* agregar un término de incremento en $dS$ para tomar en cuenta los nacidos $+bN$

* agregar un término de decremento en $dS$ para tomar en cuenta las personas susceptibles que mueren -$\mu S$

* agregar un término de decremento en $dI$ para tomar en cuenta las personas infectadas que mueren -$\mu I$

* agregar un término de decremento en $dR$ para tomar en cuenta las personas recuperadas que fallecen $-\mu R$

Use los parámetros
\[
\begin{aligned}
\beta  &=  0.4 days^{-1} &= (0.4 \times 365) years^{-1}\\
\gamma &=  0.2 days^{-1} &= (0.2 \times 365) years^{-1}\\
\mu    &=  \frac{1}{70}years^{-1}\\
b     &=  \frac{1}{70}years^{-1}\\
\end{aligned}
\]
y considere una duración de 400 años en sus cálculos.

```{r }
# 1. Configuración del Tiempo
# Usamos un paso de 1 día para mantener la resolución de las oscilaciones,
# aunque el horizonte sea de 400 años.
times_long <- seq(0, 365*400, by = 1) 

# 2. Simulación

output_longterm <- as.data.frame(ode(y = initial_state_values, 
                                     times = times_long, 
                                     func = sir_vital_dynamics, 
                                     parms = parameters_p1))
# 3. Visualización
# Graficamos dividiendo el tiempo entre 365 para ver el eje X en "Años"
ggplot(melt(output_longterm, id="time"), aes(x=time/365, y=value, col=variable)) +
  geom_line(linewidth=0.8) +
  theme_minimal() +
  labs(title = "Dinámica SIR con Nacimientos y Muertes (Largo Plazo)", 
       subtitle = "Convergencia al Equilibrio Endémico",
       y = "Población",
       x = "Tiempo (Años)",
       color = "Grupo")
```
```{r}
times_long <- seq(0, 365*200, by = 1) 

# 2. Simulación

output_longterm <- as.data.frame(ode(y = initial_state_values, 
                                     times = times_long, 
                                     func = sir_vital_dynamics, 
                                     parms = parameters_p1))
# 3. Visualización
# Graficamos dividiendo el tiempo entre 365 para ver el eje X en "Años"
ggplot(melt(output_longterm, id="time"), aes(x=time/365, y=value, col=variable)) +
  geom_line(linewidth=0.8) +
  theme_minimal() +
  labs(title = "Dinámica SIR con Nacimientos y Muertes (Largo Plazo)", 
       subtitle = "Convergencia al Equilibrio Endémico",
       y = "Población",
       x = "Tiempo (Años)",
       color = "Grupo")
```

```{r}
times_long <- seq(0, 365*100, by = 1) 

# 2. Simulación

output_longterm <- as.data.frame(ode(y = initial_state_values, 
                                     times = times_long, 
                                     func = sir_vital_dynamics, 
                                     parms = parameters_p1))
# 3. Visualización
# Graficamos dividiendo el tiempo entre 365 para ver el eje X en "Años"
ggplot(melt(output_longterm, id="time"), aes(x=time/365, y=value, col=variable)) +
  geom_line(linewidth=0.8) +
  theme_minimal() +
  labs(title = "Dinámica SIR con Nacimientos y Muertes (Largo Plazo)", 
       subtitle = "Convergencia al Equilibrio Endémico",
       y = "Población",
       x = "Tiempo (Años)",
       color = "Grupo")
```

```{r}
times_long <- seq(0, 365*50, by = 1) 

# 2. Simulación

output_longterm <- as.data.frame(ode(y = initial_state_values, 
                                     times = times_long, 
                                     func = sir_vital_dynamics, 
                                     parms = parameters_p1))
# 3. Visualización
# Graficamos dividiendo el tiempo entre 365 para ver el eje X en "Años"
ggplot(melt(output_longterm, id="time"), aes(x=time/365, y=value, col=variable)) +
  geom_line(linewidth=0.8) +
  theme_minimal() +
  labs(title = "Dinámica SIR con Nacimientos y Muertes (Largo Plazo)", 
       subtitle = "Convergencia al Equilibrio Endémico",
       y = "Población",
       x = "Tiempo (Años)",
       color = "Grupo")
```

```{r}
# --- 1. PREPARACIÓN DE DATOS (Igual que ya tenías) ---
# Simulamos los 400 años con resolución diaria
times_long <- seq(0, 365*400, by = 1) 
output_longterm <- as.data.frame(ode(y = initial_state_values, 
                                     times = times_long, 
                                     func = sir_vital_dynamics, 
                                     parms = parameters_p1))

# Agregamos columna de años para facilitar la lectura
output_longterm$Year <- output_longterm$time / 365

# Convertimos a formato largo (Melt)
data_long <- melt(output_longterm, id = c("time", "Year"))

# --- 2. TRUCO PARA ANIMACIÓN ACUMULATIVA ---
# Para que la línea "crezca" y no solo sea un punto moviéndose, 
# necesitamos crear "copias" de los datos para cada frame del slider.
# Queremos saltos de 25 años.

# Definimos los cortes de tiempo (25, 50, 75... 400)
cortes_anios <- seq(1, 400, by = 5)

accumulated_data <- list()

# Bucle estilo Python para crear los frames
for(anio_corte in cortes_anios) {
  # Filtramos los datos desde el inicio (0) hasta el año de corte actual
  # (Downsampling): Tomamos datos cada 10 días para que la animación no pese tanto y sea fluida
  subset_data <- data_long[data_long$Year <= anio_corte & data_long$time %% 10 == 0, ]
  
  # Etiquetamos estos datos con el Frame correspondiente
  subset_data$Frame <- as.factor(paste("Año", anio_corte))
  
  # Guardamos en la lista
  accumulated_data[[length(accumulated_data) + 1]] <- subset_data
}

# Unimos todo en un solo DataFrame gigante
data_for_plotly <- do.call(rbind, accumulated_data)

# --- 3. GENERAR LA GRÁFICA CON GGPLOT + PLOTLY ---

# Creamos el ggplot estático, pero agregamos el parámetro 'frame'
p <- ggplot(data_for_plotly, aes(x = Year, y = value, color = variable, frame = Frame)) +
  geom_line(linewidth = 0.8) +
  theme_minimal() +
  labs(title = "Evolución Dinámica de la Epidemia (Saltos de 25 años)",
       y = "Población",
       x = "Tiempo (Años)",
       color = "Grupo") +
  # Fijamos los límites para que los ejes no "bailen" durante la animación
  scale_x_continuous(limits = c(0, 400)) +
  scale_y_continuous(limits = c(0, 1000000))

# La magia: Convertir a interactivo
ggplotly(p) %>% 
  animation_opts(
    frame = 200, # Duración de cada frame en milisegundos (1 segundo)
    transition = 0, # Transición instantánea para que parezca que la línea se alarga
    redraw = FALSE
  ) %>%
  animation_slider(
    currentvalue = list(prefix = "Avance: ")
  )
```


## Pregunta 4

Considerando el modelo SIR básico, haga cambios para tomar en cuenta un programa de vacunación. Suponga que una fracción $v$ de susceptibles se vacuna de manera que queda inmune (y entra ahora directamente en el conjunto de los recuperados), mientras que la fracción $(1-v)$ sigue siendo susceptible. 

Calcule la dinámica de la epidemia en este caso, estudiando cómo cambia la dinámica variando la fracción $v$. Utilice $\beta=0.6$, $\gamma=0.1$ y considere un periodo de 2 años.

Su modelo debe ser capaz de mostrar que si la fracción $v$ es suficiente, no es necesario vacunar a todos los suceptibles para evitar la epidemia. A este efecto se le conoce como *inmunidad de rebaño* y se refiere a que si un sector grande de la población es inmune, entonces los contagios se mantienen a un nivel en el que la enfermedad es eliminada.

¿Cómo se puede calcular la fracción mínima $v$ de personas que se deben vacunar para poder evitar una epidemia? La inmunidad de rebaño ocurre cuando $R_{eff}< 1$

*Análisis Analítico del Umbral:*

En este caso, los parámetros han cambiado a $\beta=0.6$ y $\gamma=0.1$. Esto modifica el número reproductivo básico:
$$R_0 = \frac{0.6}{0.1} = 6$$

Para lograr la inmunidad de rebaño ($R_{eff} < 1$), calculamos la nueva fracción mínima $v$:
$$v > 1 - \frac{1}{R_0} = 1 - \frac{1}{6} \approx 0.833$$

*Interpretación:* Con estos nuevos parámetros, *es necesario vacunar al 83.3%* de la población para evitar la epidemia.
* Esto significa que el escenario solicitado del *75% no será suficiente* para detener el brote completamente (aunque lo reducirá), y necesitaremos un porcentaje mayor (ej. 90%) para observar la eliminación total.


```{r}
# Definición de parámetros
N_total <- 1000000
params_p4 <- c(beta=0.6, gamma=0.1)
times_p4 <- seq(0, 365*2, 1) # 2 años

# Escenarios de vacunación: 
# Agregamos 0.84 y 0.95 para ver el efecto de la inmunidad de rebaño (>83.3%)
v_scenarios <- c(0, 0.5, 0.75, 0.84, 0.95)

results_list <- list()

# Bucle para simular cada escenario
for(v in v_scenarios){
  # Condiciones iniciales:
  # Movemos el porcentaje 'v' directamente a Recuperados
  y_init <- c(S = (1-v)*N_total - 1, 
              I = 1, 
              R = v*N_total)
  
  # Asumiendo que la función 'sir_model' ya está definida en chunks anteriores
  out <- as.data.frame(ode(y=y_init, times=times_p4, func=sir_model, parms=params_p4))
  
  # Etiquetamos el escenario para la gráfica
  out$vacunacion <- factor(paste0(v*100, "%"), 
                           levels = paste0(v_scenarios*100, "%")) # Ordenar factores
  results_list[[length(results_list)+1]] <- out
}

# Unir todos los datos
all_results <- do.call(rbind, results_list)
```

```{r}
ggplot(all_results, aes(x=time, y=S, color=vacunacion)) +
  geom_line(linewidth=1) +
  theme_minimal() +
  labs(title = "Dinámica de Susceptibles",
       subtitle = "Beta = 0.6, Gamma = 0.1 (R0 = 6)",
       y = "Población Susceptible",
       x = "Tiempo (días)",
       color = "% Vacunado")
```

```{r}
ggplot(all_results, aes(x=time, y=I, color=vacunacion)) +
  geom_line(linewidth=1) +
  theme_minimal() +
  labs(title = "Dinámica de Infectados",
       y = "Infectados Activos",
       x = "Tiempo (días)",
       color = "% Vacunado")
```
```{r}
ggplot(all_results, aes(x=time, y=R, color=vacunacion)) +
  geom_line(linewidth=1) +
  theme_minimal() +
  labs(title = "Dinámica de Recuperados (Inmunes)",
       subtitle = "Incluye vacunados iniciales + recuperados naturales",
       y = "Población Inmune",
       x = "Tiempo (días)",
       color = "% Vacunado")
```

